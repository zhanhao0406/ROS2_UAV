# 正式前检查

ROS version check :  `echo $ROS_DISTRO  # 我的是 jazzy`  
Ubuntu version check : `lsb_release -a  # 我的是 ubuntu 24.04.3 LST, noble`   
Gazebo version check : `gz sim --version  # 我的是 8.10.0，能有输出，说明不是旧版gazebo classic`   

---
## 工作空间分类  
`mkdir -p ~/ws_xtd2/src`  
`sudo rosdepc init`  
`rosdepc update`  
`cd ..`  
`rosdepc install -i --from-path src --rosdistro jazzy -y`  
`sudo apt install python3-colcon-ros`   
`colcon build`    
然后设置环境变量  
`source install/local_setup.sh # 仅在当前终端生效，每次都要使用`   
<mark> 或者 </mark>   
`echo " source ~/dev_ws/install/local_setup.sh" >> ~/.bashrc # 所有终端均生效，需要打开bashrc文件，添加source 路径`   

---
## 根据XTD2教程，使用venv虚拟环境  
`sudo apt install python3-venv`  
`python3 -m venv ~/xtd2_pyenv  # 若需要改变环境的位置请自行修改，默认为home目录（~/）`    
`source ~/xtd2_pyenv/bin/activate # 在每次启动终端时，都激活 pyenv 虚拟环境 `   
`#解除激活   deactivate`  
为了省事，可以把source部分写进 ~/.bashrc 中   
`echo "source ~/xtd2_pyenv/bin/activate" >> ~/.bashrc # 但是我没有做，选择手动弄,可能会有混乱`   

---
## Gazebo Harmonic安装好后；  
可以从PX4添加自定义模型，将模型文件放入 ~/.simulation-gazebo 中的 models 或者 worlds 文件夹中；  
```bash
cd ~/ws_xtd2
mkdir resources && cd resources
# 下载模型，网络问题无法git的话，直接到官网下载zip，然后 unzip 解压。
git clone https://github.com/PX4/PX4-gazebo-models.git
# 名字不一致就改文件夹名
cd PX4-gazebo-models
python3 simulation-gazebo
```
python3之后开始下载，18M下载完成后自动开始gazebo然后报错。怀疑是没装PX4导致，暂时忽略。
且执行检查环境变量 `echo $GZ_SIM_RESOURCE_PATH`，输出为空；  
GPT建议我环境变量写进bashrc，还没有做。因为PX4都还没有下载。     
```bash
echo 'export GZ_SIM_RESOURCE_PATH=$GZ_SIM_RESOURCE_PATH:$HOME/ws_xtd2/resources/PX4-gazebo-models' >> ~/.bashrc
source ~/.bashrc

```

---
## PX4的安装与配置 （1.15.3）
激活 pyenv 虚拟环境，安装 python 依赖库  
<mark> GPT表明：venv只应该用于 PX4 的 Python 工具链，不能去跑ros2节点本身 </mark>
```bash
source ~/ws_xtd2_pyenv/bin/activate
pip3 install kconfiglib jinja2 pyyaml jsonschema empy==3.3.4 pyros-genmsg future catkin_pkg lark
# 在这里建议不要使用 deactivate 命令退出虚拟环境。否则后续会在bash部分遇见 python 包依赖安装失败的问题，这是新版 ubuntu的环境保护逻辑。
```
然后开始下载PX4-Autopilot    
以下 git clone 部分出问题，参考[网络问题](#网络问题)     
以下 bash ~/PX4 部分出问题，参考[系统包版本问题](#系统包版本问题)   

```bash
# 保持在虚拟环境中运行
cd ~
git clone https://github.com/PX4/PX4-Autopilot.git --recursive   # 卡在了这一步
cd PX4-Autopilot/ && git checkout v1.15.3
bash ~/PX4-Autopilot/Tools/setup/ubuntu.sh # 需要输入password
make px4_sitl
```

### 网络问题
注意：在git clone下，网络等多种都可能影响下载失败。  
* 或者可以使用修改 /etc/hosts 文件，手动配置IP地址。  
1. https://www.ipaddress.com/ 中查询 github.com 的地址。
2. sudo gedit /etc/hosts  ， 添加例如： 140.82.113.4 github.com
3. sudo service NetworkManager restart  ， 重启网络即可。

* 但是我个人试还是不行，可能是网络原因
于是又出现<mark> 方案二</mark>, 参考[链接教程](https://www.bilibili.com/video/BV1uDJ3z2Ehy/?spm_id_from=333.337.search-card.all.click&vd_source=2adffcb2e859830ea58f09c3ad77a5f0)。   
采用github加速网站  https://gh-proxy.com/

* 由于一直使用 `--recursive 指令`，最后还是会中途卡。  
中途卡重新下载，需要使用 ` rm -rf PX4-Autopilot/ `指令完全删除之前的内容。   
<mark>于是出现方案三</mark>。  
采用gitee的mirror镜像指令： `git clone https://gitee.com/mirrors_PX4/PX4-Autopilot ` ， 然后cd PX4之后，然后 `git checkout v1.15.3` 就代表成功了。

### 系统包版本问题
如果直接bash ～PX4 。。。 则会报错：`E: Unable to locate package libncurses5`，这是由于新版本的ubuntu，已经把libncurses5包取代。  
1. 安装正确的库
`sudo apt update`
`sudo apt install libncurses-dev  # 安装新版本的ncurses库，它兼容并替代了libncurses5`
2. 安装完成后，需要修改 PX4-Autopilot/Tools/setup/ubuntu.sh 内容，将其中的 libncurses5 替换为正确的包名。  
`sed -i 's/libncurses5-dev/libncurses-dev/g' Tools/setup/ubuntu.sh # 只会修改包名，不破坏脚本结构`   
如不小心改乱了ubuntu.sh,可以从仓库重新下载（确保你在PX4目录内）， `git checkout Tools/setup/ubuntu.sh`    
然后重新运行 bash 脚本即可 。
3. 在此时bash，不会碰到脚本格式检查的问题了。现在则开始安装依赖。其中 armkeil.blob.core.windows.net/ 部分非常慢，应该有其余解决方法，但是我这里选择了等待。
4. 如果碰到了java ersion出现问题，报错`E: Unable to locate package openjdk-14-jre && E: Unable to locate package openjdk-14-jdk`之类的问题，这是因为ubuntu.sh部分没有针对ubuntu 24.04部分进行设定，需要手动修改。  
   首先打开ubuntu.sh这个文件，然后添加   
   `elif [[ "${UBUNTU_RELEASE}" == "24.04" ]]; then
        java_version=17  # 或者使用 21，取决于你的系统`   
   之后保存并重新运行脚本即可。
5. 后续又碰到报错：`E: Package 'gazebo11' has no installation candidate && E: Unable to locate package libgazebo11-dev`同样是因为没有 ubuntu 24.04的设定，需要手动改。    
   把脚本中的 Gazebo installation 部分的那一行，改为：`if [[ "${UBUNTU_RELEASE}" == "22.04" || "${UBUNTU_RELEASE}" == "24.04" ]]; then`
   然后把其中的 `garden`  部分改为 `harmonic`。 因为`gz sim --version` 输出的版本一开始就是8.xx.xx,已经是harmonic版本了。
6. 之后就安装没有问题了，最后输出让我reboot to build NuttX targets.


